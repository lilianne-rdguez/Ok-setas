---
---
<div id="cart-drawer-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300"></div>

<aside id="cart-drawer" class="fixed top-0 right-0 h-full w-full sm:w-[400px] bg-bg-dark border-l border-white/10 z-[60] transform translate-x-full transition-transform duration-300 flex flex-col shadow-2xl shadow-black/50">
    <!-- Header -->
    <div class="px-6 py-6 border-b border-white/10 flex items-center justify-between">
        <h2 class="font-display text-2xl font-bold uppercase tracking-widest flex items-center gap-3">
            <span class="material-symbols-outlined text-gold">local_mall</span>
            Tu Carrito
        </h2>
        <button id="close-cart" class="text-gray-400 hover:text-white transition-colors cursor-pointer p-1">
            <span class="material-symbols-outlined text-3xl">close</span>
        </button>
    </div>

    <!-- Items -->
    <div id="cart-items-container" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4">
        <!-- Vacio por defecto o generado por JS -->
    </div>

    <!-- Footer -->
    <div class="border-t border-white/10 p-6 bg-white/5">
        <div class="flex justify-between items-center mb-6">
            <span class="text-gray-400 uppercase tracking-widest text-sm font-bold">Total estimado</span>
            <span id="cart-total" class="font-mono text-2xl font-bold text-white">0,00 €</span>
        </div>
        <a href="https://ximoe124.sg-host.com/checkout/" id="checkout-btn" class="w-full bg-[#A03D45] text-white font-bold py-4 rounded-xl hover:bg-red-800 transition-all duration-300 uppercase tracking-widest shadow-[0_4px_20px_rgba(160,61,69,0.3)] flex items-center justify-center gap-2 cursor-pointer">
            <span class="material-symbols-outlined">lock</span>
            Finalizar Compra
        </a>
        <p class="text-center text-xs text-gray-500 mt-4 font-light">
            Impuestos y propinas de envío en la pantalla de pago.
        </p>
    </div>
</aside>

<style>
    /* Ocultar barra de scroll para el carrito */
    #cart-items-container::-webkit-scrollbar {
        width: 6px;
    }
    #cart-items-container::-webkit-scrollbar-track {
        background: transparent;
    }
    #cart-items-container::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
    }
</style>

<script>
    import { getCart, removeFromCart, updateQuantity, getCartTotal, saveCart, addToCart } from '../utils/cartStore.js';

    document.addEventListener("DOMContentLoaded", () => {
        const overlay = document.getElementById("cart-drawer-overlay");
        const drawer = document.getElementById("cart-drawer");
        const closeBtn = document.getElementById("close-cart");
        const itemsContainer = document.getElementById("cart-items-container");
        const totalEl = document.getElementById("cart-total");

        // Funciones para abrir y cerrar
        (window as any).openCart = () => {
            overlay.classList.remove("hidden");
            // Pequeño delay para animar opacity tras quitar hidden
            setTimeout(() => {
                overlay.classList.remove("opacity-0");
                drawer.classList.remove("translate-x-full");
            }, 10);
            renderCart();
        };

        (window as any).closeCart = () => {
            overlay.classList.add("opacity-0");
            drawer.classList.add("translate-x-full");
            setTimeout(() => {
                overlay.classList.add("hidden");
            }, 300);
        };

        // Listeners apertura desde cualquier boton con la clase
        document.addEventListener('click', (e) => {
            const btn = (e.target as Element).closest('.open-cart-btn');
            if (btn) {
                e.preventDefault();
                (window as any).openCart();
            }
        });

        overlay?.addEventListener("click", (window as any).closeCart);
        closeBtn?.addEventListener("click", (window as any).closeCart);

        // Render logic
        const renderCart = () => {
            const cart = getCart();

            if (cart.length === 0) {
                itemsContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center text-gray-400 opacity-60">
                        <span class="material-symbols-outlined text-6xl mb-4">production_quantity_limits</span>
                        <p class="uppercase tracking-widest text-sm font-bold">Tu carrito está vacío</p>
                    </div>
                `;
            } else {
                itemsContainer.innerHTML = cart.map(item => `
                    <div class="flex gap-4 bg-white/5 border border-white/10 p-4 rounded-xl relative group">
                        <!-- Img -->
                        <div class="w-16 h-16 bg-white rounded-lg p-2 flex-shrink-0 flex items-center justify-center">
                            <img src="${item.image}" class="max-w-full max-h-full object-contain" alt="">
                        </div>
                        
                        <!-- Info -->
                        <div class="flex-1 flex flex-col justify-center">
                            <h4 class="font-bold text-white text-[13px] leading-tight pr-6">${item.title}</h4>
                            <p class="text-gold font-mono text-sm font-bold mt-1">${item.price}</p>
                            
                            <!-- Controles -->
                            <div class="flex items-center gap-3 mt-3">
                                <div class="flex items-center bg-transparent rounded border border-white/20 h-7 overflow-hidden">
                                    <button onclick="window.updateCartItem('${item.id}', ${item.quantity - 1})" class="w-7 h-full flex justify-center items-center hover:bg-white/10 text-white">-</button>
                                    <span class="w-8 text-center font-mono text-xs">${item.quantity}</span>
                                    <button onclick="window.updateCartItem('${item.id}', ${item.quantity + 1})" class="w-7 h-full flex justify-center items-center hover:bg-white/10 text-gold">+</button>
                                </div>
                            </div>
                        </div>

                        <!-- Borrar -->
                        <button onclick="window.removeCartItem('${item.id}')" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 transition-colors p-1 flex items-center justify-center">
                            <span class="material-symbols-outlined text-lg">delete</span>
                        </button>
                    </div>
                `).join('');
            }

            // Update Total
            const total = getCartTotal();
            totalEl.innerText = total.toLocaleString('es-ES', { minimumFractionDigits: 2 }) + ' €';
        };

        // Métodos globales para usar inline onclick
        (window as any).updateCartItem = (id, qnty) => {
            updateQuantity(id, qnty);
        };
        
        (window as any).removeCartItem = (id) => {
            removeFromCart(id);
        };

        (window as any).addToCartGlobal = (productData) => {
            addToCart(productData, productData.quantity || 1);
            (window as any).openCart();
        };

        // Escuchar cambios
        window.addEventListener('cart-updated', () => {
            renderCart();
            updateCartBadge();
        });

        // Badge en el header
        const updateCartBadge = () => {
            const cart = getCart();
            const totalItems = cart.reduce((acc, it) => acc + it.quantity, 0);
            
            document.querySelectorAll('.cart-badge').forEach(badge => {
                badge.textContent = totalItems.toString();
                if (totalItems > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
        };

        // Initial update
        updateCartBadge();
    });
</script>
